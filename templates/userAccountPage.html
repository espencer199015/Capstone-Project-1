<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='loginSignupStyle.css') }}">

    <title>User Account</title>
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <ul>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li><a href="{{ url_for('lesson_page') }}">Lessons</a></li>
            {% if user %}
                <li><a href="{{ url_for('user_account_page') }}">Howdy, {{ user.username }}!</a></li>
                <li>
                    <form action="/logout" method="post">
                        <input class="logout-button" type="submit" value="Logout">
                    </form>
                </li>
            {% else %}
                <li><a href="{{ url_for('login_signup_page') }}">Login/Signup</a></li>
            {% endif %}
        </ul>
    </nav>

    <div id="account-details">
        <h1>User Account Details</h1>
        {% if user %}
            <!-- Display user information if authenticated -->
            <p>Username: {{ user.username }}</p>
            <p>Email: {{ user.email }}</p>
            <p>First Name: {{ user.first_name }}</p>
            <p>Last Name: {{ user.last_name }}</p>
            <p>Home Address: {{ user.home_address }}</p>
            <p>City/Town: {{ user.city_town }}</p>
            <p>State: {{ user.state }}</p>
            <p>Zip Code: {{ user.zip_code }}</p>
            <!-- edit button -->
            <button type="submit">EDIT</button>
        {% else %}
            <p>User not authenticated.</p>
        {% endif %}
    </div>   

    <!-- Cart Section -->
    <div id="cart-section" style="display: none;">
        <h1>Shopping Cart</h1>
        <div id="cart-items-list">
            {% for lesson in session['cart'] %}
                <p>Lesson Name: {{ lesson['lesson_name'] }}</p>
                <p>Price: ${{ lesson['lesson_price'] }}</p>
                <form action="/remove_lesson" method="post">
                    <input type="hidden" name="lesson_name" value="{{ lesson['lesson_name'] }}">
                    <button type="submit">Remove</button>
                </form>
            {% endfor %}
        </div>
        <!-- Replace this with your actual checkout button -->
        <button id="checkout-btn">Checkout with PayPal</button>
    </div>

    <button id="view-cart">View Cart</button>

    <!-- Transaction History -->
    <div id="transaction-history">
        <h1>Transaction History</h1>
        <ul id="payment-list">
            <!-- List for displaying payment details -->
        </ul>
    </div>

    <footer></footer>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Make a GET request to retrieve payments
        fetch('/get_payments')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const paymentList = document.getElementById('payment-list');

                    // Iterate through payments and display in the list
                    data.payments.payments.forEach(payment => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `Payment ID: ${payment.id}, Amount: ${payment.amount_money.amount} ${payment.amount_money.currency}`;
                        paymentList.appendChild(listItem);
                    });
                } else {
                    console.error('Error fetching payments:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching payments:', error);
            });

        document.getElementById('checkout-btn').addEventListener('click', function() {
            // Retrieve lesson details from the cart
            const lessons = [
                {% for lesson in session['cart'] %}
                    {
                        lesson_name: "{{ lesson['lesson_name'] }}",
                        lesson_price: {{ lesson['lesson_price'] }}
                    },
                {% endfor %}
            ]; // Replace this with your code to get lessons from the cart

            // Create an array to hold PayPal items
            const paypalItems = lessons.map(lesson => {
                return {
                    name: lesson.lesson_name,
                    unit_amount: {
                        currency_code: 'USD',
                        value: lesson.lesson_price.toFixed(2) // Assuming lesson_price is a numeric value
                    },
                    quantity: 1,
                    category: 'Lessons' // Update this category if needed
                };
            });

            // Set up PayPal configuration
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                currency_code: 'USD',
                                value: totalCartAmount(lessons).toFixed(2) // Calculate total cart amount dynamically
                            },
                            items: paypalItems // Add items dynamically to the PayPal order
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    // Handle successful payment approval
                    // You may want to perform actions like updating the database here
                    console.log('Payment completed:', data);
                },
                onError: function(err) {
                    // Handle errors during the checkout process
                    console.error('Error during checkout:', err);
                }
            }).render('#paypal-button-container');
        });

        // Function to calculate total cart amount
        function totalCartAmount(lessons) {
            let total = 0;
            for (const lesson of lessons) {
                total += lesson.lesson_price;
            }
            return total;
        }
    </script>
</body>
</html>